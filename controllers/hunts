// controllers/hunts.js
const express = require('express');
const router = express.Router({ mergeParams: true });

const Hunt = require('../models/hunt');

//I.N.D.U.C.E.S 
// Index GET /hunts
router.get("/", async (req, res) => {
    const hunts = await Hunt.find().populate('owner');
    console.log(hunts)
    res.render('hunts/index.ejs', { hunts });
});

// NEW GET /hunts/new

router.get("/new", async (req, res) => {
    const monsterResponse = await fetch('https://mhw-db.com/monsters')
    const monsters = await monsterResponse.json();
    const weaponResponse = await fetch('https://mhw-db.com/weapons')
    const weapons = await weaponResponse.json();
    const uniqueWeaponTypes = [...new Set(weapons.map(weapon => weapon.type))];
        console.log(uniqueWeaponTypes);
    res.render("hunts/new.ejs", { monsters, weapons: uniqueWeaponTypes });
    //GET back all the monsters from the mhw and send them back to the new ejs
    //new.ejs will need a drop down displaying all the monsters
    //when the form is submitted, the selected monster will be sent as part of the req.body
})

//Delete DELETE /hunts/:huntid
router.delete("/:huntid", async (req, res) => {
    try {
        const foundHunt =  await Hunt.findById(req.params.huntid)
        if(!foundHunt.owner._id.equals(req.session.user._id)){
         throw new Error("You do not have permission to delete this hunt")
        }

        await foundHunt.deleteOne();
        res.redirect("/hunts");

    } catch (error) {
        console.log(error)
        req.session.message = error.message
        req.session.save(()=>{
            res.redirect(`/hunts/${req.params.huntid}`)
        })
    }
})

//UPDATE PUT /hunts/:huntid
router.put("/:huntid", async (req, res) => {
    console.log(req.body);

    const monster = await fetch('https://mhw-db.com/monsters/'+ req.body.mhwid)
    const monsterData = await monster.json();
    req.body.monsterName = monsterData.name;


    try {

const foundHunt =  await Hunt.findById(req.params.huntid)
        if(!foundHunt.owner._id.equals(req.session.user._id)){
         throw new Error("You do not have permission to update this hunt")
    }
        await foundHunt.updateOne(req.body)
        res.redirect('/hunts/')

    } catch (error) {
        console.log(error);
        req.session.message = error.message;
        req.session.save(()=> {
            res.redirect("/hunts");
})
    }
});


// CREATE POST /hunts
router.post("/", async (req, res) => {
    console.log(req.body)
    try {
        const { rank, outcome, minutes, notes } = req.body
        if(rank < 0 || rank === '') throw new Error('Rank must be a positive number')
        if(outcome < 0 || outcome === '') throw new Error('Outcome must be a positive number')
        if(minutes < 0 || minutes === '') throw new Error('Minutes must be a positive number')

            req.body.owner = req.session.user._id

        const monster = await fetch('https://mhw-db.com/monsters/'+ req.body.mhwid)
    const monsterData = await monster.json();
    req.body.monsterName = monsterData.name;

    await Hunt.create(req.body);
    res.redirect("/hunts");


    } catch (error) {
        console.log(error)
        req.session.message = error.message
        req.session.save(()=>{
            res.redirect('/hunts/new')
        })
        
    }

});


//seed route
router.get("/seed", async (req, res) => {
    await Hunt.deleteMany({});
       
    res.redirect('/hunts');
});

//EDIT GET /hunts/:huntid/edit
router.get("/:huntid/edit", async (req, res) => {
    try{
        const foundHunt = await Hunt.findById(req.params.huntid)
        const monsterResponse = await fetch('https://mhw-db.com/monsters')
    const monsters = await monsterResponse.json();
    const weaponResponse = await fetch('https://mhw-db.com/weapons')
    const weapons = await weaponResponse.json();
    const uniqueWeaponTypes = [...new Set(weapons.map(weapon => weapon.type))];
        console.log(foundHunt);
        if(!foundHunt) throw new Error(`Failed to find hunt with id ${req.params.huntid}`);
        res.render("hunts/edit.ejs", { monsters, weapons: uniqueWeaponTypes, hunt: foundHunt });
    } catch (error) {
        console.log(error);
        req.session.message = error.message;
        req.session.save(()=> {
            res.redirect("/hunts");
})
    }
})

//Show GET /hunts/:huntid
router.get("/:huntid", async (req, res) => {
    console.log(req.params);
    try{
        const foundHunt = await Hunt.findById(req.params.huntid).populate('owner');
        console.log(foundHunt);
        const mhwid = foundHunt.mhwid;
        console.log(mhwid);
        const mhwtype = foundHunt.weaponType;
        const monsterResponse = await fetch('https://mhw-db.com/monsters/' + mhwid)
        console.log(monsterResponse);
        const monsters = await monsterResponse.json();
        const userHasLikedItem = foundHunt.favoritedByUsers.some(user => {
           return user._id.equals(req.session.user._id);
        })
        console.log(monsters);
        if(!foundHunt) throw new Error(`Failed to find hunt with id ${req.params.huntid}`);
        res.render("hunts/show.ejs", { monster: monsters, hunt: foundHunt, userHasLikedItem });
    } catch (error) {
        console.log(error);
        req.session.message = error.message;
        req.session.save(()=> {
            res.redirect("/hunts");

    });
    }
});

router.post("/:huntid/favorited-by/:userId", async (req, res) => {
    try {
        await Hunt.findByIdAndUpdate(
            req.params.huntid,
            { $push: { favoritedByUsers: req.params.userId } }
        );
        res.redirect(`/hunts/${req.params.huntid}`);
    } catch (error) {
        console.log(error);
        req.session.message = error.message;
        req.session.save(()=> {
            res.redirect("/hunts");
});
    }
});       

router.delete("/:huntid/favorited-by/:userId", async (req, res) => {
    try {
        await Hunt.findByIdAndUpdate(
            req.params.huntid,
            { $pull: { favoritedByUsers: req.params.userId } }
        );
        res.redirect(`/hunts/${req.params.huntid}`);
    } catch (error) {
        console.log(error);
        req.session.message = error.message;
        req.session.save(()=> {
            res.redirect("/hunts");
});
    }
});  

module.exports = router;

